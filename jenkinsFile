pipeline {
    agent any

    environment {
        GITHUB_TOKEN = credentials('github-token')  // Usa el ID de la credencial
        API_URL = 'http://localhost:8080/actividades'
    }

    stages {
        stage('Clonar Repositorio') {
            steps {
                git url: 'https://github.com/GAbriElaJnbg30/Testing_ApiRest.git', credentialsId: 'github-token'
            }
        }

        stage('Ejecutar Contenedor') {
            steps {
                script {
                    sh "docker stop apirestgo-api-go-container || true"
                    sh "docker rm apirestgo-api-go-container || true"
                    sh "docker run -d --name apirestgo-api-go-container -p 8080:8080 apirestgo-api-go:latest"
                }
            }
        }

        stage('Ejecutar Pruebas de API') {
            steps {
                script {
                    // Usando el token de GitHub almacenado en la variable de entorno
                    sh """
                    echo "Probando conexi√≥n a la API..."
                    curl -X GET "${API_URL}" -H "Authorization: Bearer ${GITHUB_TOKEN}"
                    """
                }
            }
        }
    }

    post {
        always {
            sh "docker stop apirestgo-api-go-container || true"
            sh "docker rm apirestgo-api-go-container || true"
        }
    }
}
